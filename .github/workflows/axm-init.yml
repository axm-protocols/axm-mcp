name: axm-init check

on:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  check:
    name: AXM Check & Badge
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - uses: astral-sh/setup-uv@v7
      - run: uv python install 3.12

      - name: Run AXM Check
        id: check
        run: |
          RESULT=$(uvx axm-init check . --json) || true
          SCORE=$(echo "$RESULT" | jq '.score')
          GRADE=$(echo "$RESULT" | jq -r '.grade')
          echo "score=$SCORE" >> "$GITHUB_OUTPUT"
          echo "grade=$GRADE" >> "$GITHUB_OUTPUT"
          echo "ðŸ“‹ AXM Check: Score $SCORE/100 â€” Grade $GRADE"

      - name: Choose badge color
        id: color
        run: |
          SCORE=${{ steps.check.outputs.score }}
          if [ "$SCORE" -ge 95 ]; then COLOR="brightgreen"
          elif [ "$SCORE" -ge 80 ]; then COLOR="green"
          elif [ "$SCORE" -ge 60 ]; then COLOR="yellow"
          else COLOR="red"; fi
          echo "color=$COLOR" >> "$GITHUB_OUTPUT"

      - name: Generate badge JSON
        run: |
          mkdir -p badges
          LOGO_SVG=$(curl -fsSL https://raw.githubusercontent.com/axm-protocols/axm-init/main/assets/logo.svg)
          jq -n \
            --arg score "${{ steps.check.outputs.score }}" \
            --arg color "${{ steps.color.outputs.color }}" \
            --arg logo "$LOGO_SVG" \
            '{
              schemaVersion: 1,
              label: "axm-init",
              message: "\($score)%",
              color: $color,
              logoSvg: $logo,
              style: "flat"
            }' > badges/axm-init.json

      - name: Push badge to gh-pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: ./badges
          destination_dir: badges
          keep_files: true
          commit_message: "badge: update axm-init score to ${{ steps.check.outputs.score }}/100"
